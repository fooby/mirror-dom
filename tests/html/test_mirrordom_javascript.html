<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/common.js"></script>
    <script type="text/javascript" src="../../js/broadcaster.js"></script>
    <script type="text/javascript" src="../../js/viewer.js"></script>
    <script type="text/javascript" src="test_util.js"></script>
    <script type="text/javascript" src="json2.js"></script>
    <script type="text/javascript" >
      var broadcaster_iframe = null;
      var viewer_iframe = null;
      var broadcaster = null;
      var viewer = null;

      // Initialisation
      jQuery(document).ready(function() {
          broadcaster_iframe = document.getElementById("broadcaster_iframe");          
          viewer_iframe = document.getElementById("viewer_iframe");          
          broadcaster = new MirrorDom.Broadcaster({
              iframe: broadcaster_iframe
          });

          viewer = new MirrorDom.Viewer({
              iframe: viewer_iframe,
              blank_page: "blank.html",
              debug: true
          });
      });

      // ************** UNIT TESTS ****************

      // Test 1: Test retrieve html
      // ------------------------------------------

      function test_1_get_broadcaster_document() {
          var data = broadcaster.start_full_document();
          return data["html"];
      }

      // Test 2: Test apply html
      // ------------------------------------------
      function test_2_apply_document(result) {
          //debugger;
          var doc_elem = viewer.get_document_element();
          viewer.apply_document(doc_elem, result); 
      }

      // Test 3: Test get diff
      // ------------------------------------------
      function test_3_modify_broadcaster_document_with_add_node() {
          test_3_force_dom_clone();
          broadcaster_iframe.contentWindow.add_div();
      }

      function test_3_force_dom_clone() {
          broadcaster.make_dom_clone();
      }

      function test_3_get_broadcaster_diff() {
          var diff = broadcaster.get_diff();
          return diff;
      }

      // Test 4: Test apply diff
      // ------------------------------------------
      function test_4_setup_viewer_document() {
          viewer_iframe.src = "test_mirrordom_javascript_content_sanitised.html";
      }

      function test_4_apply_viewer_diff(diffs) {
          var diffs = JSON.parse(diffs);
          viewer.apply_diffs(null, diffs);
      }

      // Test 5: Test get initial property dump
      // ------------------------------------------
      function test_5_get_broadcaster_all_property_diff() {
          var data = broadcaster.start_full_document();
          return data["props"];
      }

      // Test 6: Test get diff with dynamic class/style change
      // ------------------------------------------
      function test_6_modify_broadcaster_document_with_css() {
          test_3_force_dom_clone();
          broadcaster_iframe.contentWindow.change_some_css();
      }

      // Test 7: Test get diff with attribute change
      // ------------------------------------------
      function test_7_modify_broadcaster_document_with_attribute() {
          test_3_force_dom_clone();
          broadcaster_iframe.contentWindow.change_some_attribute();
      }

      // Test 8: Test get diff with property change
      // ------------------------------------------
      //function test_8_modify_broadcaster_document_with_property() {
      //    broadcaster_iframe.contentWindow.change_some_property();
      //}

      // Test 9: Test get diff with deleting nodes
      // ------------------------------------------
      function test_9_modify_broadcaster_document_with_delete_node() {
          test_3_force_dom_clone();
          broadcaster_iframe.contentWindow.delete_div();
      }


      // Test 14 + 15: Jquery UI dialog
      // ------------------------------------------
      function test_14_broadcaster_open_jquery_dialog() {
          test_3_force_dom_clone();
          broadcaster_iframe.contentWindow.make_and_show_dialog();
      }

      function test_15_broadcaster_open_jquery_dialog() {
          test_3_force_dom_clone();
          broadcaster_iframe.contentWindow.close_dialog();
      }

      // Test 16: Text nodes
      // ------------------------------------------
      function test_16_broadcaster_add_text_nodes(text_items) {
          broadcaster_iframe.contentWindow.add_text_nodes(text_items);
      }

      function test_16_broadcaster_get_text_at_path(path) {
          var doc_elem = broadcaster.get_document_element();
          var node = MirrorDom.Util.node_at_path(doc_elem, path);
          return MirrorDom.Util.get_text_node_content(node);
      }

      // *************** END TESTS *****************

      // The following functions are used for doing the testing verification
      function get_broadcaster_html() {
          return MDTestUtil.get_html(broadcaster_iframe);
      }

      function get_viewer_html() {
          return MDTestUtil.get_html(viewer_iframe);
      }

      function manual_dump() {
          var html = 
 '   <html> \
      <head> \
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta> \
        <sc' + 'ript src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></scr' + 'ipt> \
        <sc' + 'ript type="text/javascript"></scr' + 'ipt> \
        <style type="text/css">table { border-collapse: collapse; } \
        table,th,td { border: 1px solid black; }</style> \
      </head> \
      <body> \
        <h3>Hallow world!</h3> \
        <div> \
        ohay \
          <table id="thetable" style="border: 1px solid pink;"> \
          <tr> \
            <th>1</th> \
            <th>2</th> \
          </tr> \
          <tr> \
            <td>a</td> \
            <td>b</td> \
          </tr> \
          <tr> \
            <td>c</td> \
            <td>d</td> \
          </tr> \
          </table> \
        </div> \
        <div> \
          <input id="thetextinput" length="50" type="text" value="hello"></input> \
        </div> \
        <a href="test_mirrordom_javascript_content2.html">Page 2</a> \
      </body> \
    </html>';
          viewer.apply_document(null, html);
      }

      function manual_get_property_diffs() {
          debugger;
          var diffs = broadcaster.get_property_diffs();
          console.log("Diffs: " + diffs);
      } 

      function manual_diff() {
          test_3_modify_broadcaster_document_with_add_node();
          debugger;
          var diff = test_3_get_broadcaster_diff();
          console.log("Diff: " + JSON.stringify(diff));
      }

      function manual_apply_diff() {
          var DIFF = [["node", [1, 4], "Hello There", {"attributes": {"style": "background-color: red;"}, "nodeType": 1, "nodeName": "DIV", "nodeValue": null}, []]];
          test_4_setup_viewer_document();

          window.setTimeout(function() {
            debugger;
            test_4_apply_viewer_diff(DIFF);
          }, 1000);
      }

      function manual_apply_diff_css() {
          test_1_get_broadcaster_document();
          test_6_modify_broadcaster_document_with_css();
          debugger;
          var diff = test_3_get_broadcaster_diff();
          console.log("Diff: " + JSON.stringify(diff));
      }

      function manual_get_diff_delete() {
          test_9_modify_broadcaster_document_with_delete_node();
          var diff = test_3_get_broadcaster_diff();
          console.log("Diff: " + JSON.stringify(diff));
      }

      function manual_apply_diff_delete() {
          test_4_setup_viewer_document();
          var DIFFS = [["deleted",[1,4]]];
          test_4_apply_viewer_diff(DIFFS);
      }

      function ignore_text_nodes() {
          console.log(test_16_broadcaster_get_text_at_path([1,1,0]));
          test_16_broadcaster_add_text_nodes(["hello ", "world"]);
          console.log(test_16_broadcaster_get_text_at_path([1,1,2]));
      }
    </script>
  </head>
  <body>
    <iframe id="broadcaster_iframe" name="broadcaster_iframe" src="test_mirrordom_javascript_content.html" style="width: 100%; height: 200px"></iframe>
    <iframe id="viewer_iframe" name="viewer_iframe" src="blank.html" style="width: 100%; height: 200px"></iframe>

    <a href="javascript:manual_dump()">Manual dump!</a><br/>
    <a href="javascript:manual_get_property_diffs()">Manual get ALL property diffs!</a><br/>
    <a href="javascript:manual_diff()">Manual diff!</a><br/>
    <a href="javascript:manual_apply_diff()">Manual apply diff!</a><br/>
    <a href="javascript:manual_apply_diff_css()">Manual get diff with css!</a><br/>
    <a href="javascript:manual_get_diff_delete()">Manual get diff with delete!</a><br/>
    <a href="javascript:manual_apply_diff_delete()">Manual apply diff with delete!</a><br/>
    <a href="javascript:ignore_text_nodes()">Manual ignore text nodes</a><br/>
  </body>
</html>
