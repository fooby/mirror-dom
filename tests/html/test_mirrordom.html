<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=IE9" />
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
    <script type="text/javascript" src="../../js/common.js"></script>
    <script type="text/javascript" src="../../js/broadcaster.js"></script>
    <script type="text/javascript" src="../../js/viewer.js"></script>
    <script type="text/javascript" src="test_util.js"></script>
    <script type="text/javascript" src="json2.js"></script>
    <script type="text/javascript" >
      var broadcaster_iframe = null;
      var viewer_iframe = null;
      var broadcaster = null;
      var viewer = null;

      // Initialisation
      jQuery(document).ready(function() {
          broadcaster_iframe = document.getElementById("broadcaster_iframe");          
          viewer_iframe = document.getElementById("viewer_iframe");          
          broadcaster = new MirrorDom.Broadcaster({
              iframe: broadcaster_iframe
          });

          viewer = new MirrorDom.Viewer({
              iframe: viewer_iframe,
              blank_page: "blank.html"
          });
      });

      // ************** UNIT TESTS ****************

      // Test 1: Test retrieve, sanitise and apply html
      // ------------------------------------------

      function test_1_get_broadcaster_document() {
          var data = broadcaster.start_full_document();
          //return JSON.stringify(data["html"]);
          return JSON.stringify(data["html"]);
      }

      function test_1_apply_viewer_document(doc) {
          //var d = JSON.parse(result);
          de = viewer.get_document_element();
          viewer.apply_document(de, doc); 
      }

      // Test 2: Test retrieve, sanitise and apply diff
      // Note: This builds off test_1
      // ------------------------------------------
      function test_2_modify_broadcaster_document() {
          broadcaster_iframe.contentWindow.add_div();
      }

      function test_2_get_broadcaster_diff() {
          var diff = broadcaster.get_diff();
          // Can't rely on selenium's JSON handling
          return JSON.stringify(diff);
      }

      function test_2_apply_viewer_diff(diff) {
          //debugger;
          return viewer.apply_diffs(null, diff);
      }

      // Test 3: Test get initial inline css dump
      // ------------------------------------------
      function test_3_modify_broadcaster_document_with_css() {
          broadcaster_iframe.contentWindow.change_some_css();
      }

      function test_3_get_broadcaster_all_property_diffs() {
          var data = broadcaster.start_full_document();
          //return JSON.stringify(data["props"]);
          return data["props"];
      }

      // Test 5: Test apply diff of inserted element (i.e. not at end of body)
      // ------------------------------------------
      function test_5_modify_broadcaster_document_insert_element() {
          broadcaster_iframe.contentWindow.insert_div();
      }

      // Test 5: Test apply diff of inserted table
      // ------------------------------------------
      function test_6_modify_broadcaster_document_insert_table() {
          broadcaster_iframe.contentWindow.insert_table();
      }
      // *************** END TESTS *****************


      function manual_dump() {
          var html = '';
          viewer.apply_document(html);
      }

      function manual_diff() {
          test_2_modify_broadcaster_document();
          var result = test_2_get_broadcaster_diff();
          console.log(result);
      }

      // The following functions are used for doing the testing verification
      function get_broadcaster_html() {
          return MDTestUtil.get_html(broadcaster_iframe);
      }

      function get_viewer_html() {
          return MDTestUtil.get_html(viewer_iframe);
      }

    </script>
  </head>
  <body>
    <iframe id="broadcaster_iframe" name="broadcaster_iframe" src="test_mirrordom_content.html" style="width: 100%; height: 200px"></iframe>
    <iframe id="viewer_iframe" name="viewer_iframe" src="blank.html" style="width: 100%; height: 200px"></iframe>

    <a href="javascript:manual_dump()">Manual dump!</a><br/>
    <a href="javascript:manual_diff()">Manual diff!</a>
  </body>
</html>
